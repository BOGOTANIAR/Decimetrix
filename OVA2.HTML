<!doctype html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>OVA Decimetrix | Normativa UAS y Seguridad Operacional</title>

  <!-- Tailwind CDN (si la usas offline, reemplaza por CSS propio) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { outfit: ["Outfit", "ui-sans-serif", "system-ui"] },
          boxShadow: {
            glow: "0 0 0 1px rgba(34,211,238,.25), 0 10px 40px rgba(0,0,0,.35)",
          }
        }
      }
    }
  </script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    * { font-family: Outfit, system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    .bg-grid {
      background-image:
        radial-gradient(circle at 1px 1px, rgba(148,163,184,.18) 1px, transparent 0);
      background-size: 18px 18px;
    }
    .glass {
      background: rgba(2, 6, 23, .62);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(148, 163, 184, .18);
    }
    .chip {
      border: 1px solid rgba(148,163,184,.22);
      background: rgba(15, 23, 42, .65);
    }
    .btn {
      border: 1px solid rgba(34,211,238,.35);
      background: linear-gradient(135deg, rgba(34,211,238,.18), rgba(59,130,246,.14));
    }
    .btn:hover { filter: brightness(1.08); }
    .danger { border-color: rgba(248,113,113,.40) !important; }
    .ok { border-color: rgba(34,197,94,.40) !important; }
    .warn { border-color: rgba(251,191,36,.45) !important; }
    .no-print { }
    @media print {
      .no-print { display: none !important; }
      #printArea { display: block !important; }
      body { background: white !important; }
    }
  </style>
</head>

<body class="min-h-screen text-slate-100 bg-slate-950 bg-grid">
  <!-- App Shell -->
  <div class="max-w-7xl mx-auto p-4 md:p-6 no-print">
    <!-- Top bar -->
    <div class="glass shadow-glow rounded-3xl p-4 md:p-5 flex flex-col md:flex-row md:items-center md:justify-between gap-3">
      <div class="flex items-center gap-3">
        <!-- Logo simple (SVG) -->
        <div class="w-11 h-11 rounded-2xl grid place-items-center"
             style="background: radial-gradient(circle at 30% 30%, rgba(34,211,238,.25), rgba(59,130,246,.10)); border:1px solid rgba(148,163,184,.22);">
          <svg width="26" height="26" viewBox="0 0 24 24" fill="none" class="opacity-90">
            <path d="M12 2l2.2 4.5L19 7l-3.5 3.4.9 4.9L12 13.7 7.6 15.3l.9-4.9L5 7l4.8-.5L12 2z"
                  stroke="rgba(34,211,238,.95)" stroke-width="1.4" />
            <path d="M4 20c2.5-2.2 5.1-3.3 8-3.3S17.5 17.8 20 20"
                  stroke="rgba(59,130,246,.85)" stroke-width="1.4" stroke-linecap="round"/>
          </svg>
        </div>

        <div>
          <div class="text-xs text-slate-300 tracking-wide">OVA interactiva</div>
          <div class="text-lg md:text-xl font-extrabold leading-tight">
            Decimetrix | Normativa UAS y Seguridad Operacional
          </div>
        </div>
      </div>

      <div class="flex flex-col md:items-end gap-2">
        <div class="flex flex-wrap items-center gap-2">
          <span id="chipUser" class="chip rounded-full px-3 py-1 text-sm text-slate-200">
            üë§ Invitado(a) | Sin perfil
          </span>
          <span id="chipScore" class="chip rounded-full px-3 py-1 text-sm text-slate-200">
            üß† Puntaje: 0
          </span>
          <span id="chipProgress" class="chip rounded-full px-3 py-1 text-sm text-slate-200">
            ‚úÖ Progreso: 0%
          </span>
        </div>
        <div class="text-xs text-slate-400 max-w-xl md:text-right">
          Esta OVA es para <b>repaso</b>. Operaci√≥n real: siempre con el <b>Manual Decimetrix</b>, permisos vigentes y evaluaci√≥n de riesgos.
        </div>
      </div>
    </div>

    <!-- Main layout -->
    <div class="mt-5 grid grid-cols-1 lg:grid-cols-12 gap-5">
      <!-- Sidebar -->
      <aside class="lg:col-span-4">
        <div class="glass rounded-3xl p-4 md:p-5 shadow-glow">
          <div class="flex items-center justify-between">
            <div class="text-sm font-semibold text-slate-200">Ruta de aprendizaje</div>
            <button id="btnReset" class="text-xs px-3 py-1 rounded-full chip hover:brightness-110">
              Reiniciar
            </button>
          </div>

          <div id="nav" class="mt-3 space-y-2"></div>

          <div class="mt-4 p-3 rounded-2xl chip text-xs text-slate-300">
            <div class="font-semibold text-slate-200 mb-1">Modo Instructor (opcional)</div>
            <div>Sirve para cargar ‚Äúrespuestas correctas‚Äù del Manual Decimetrix y evaluar con exactitud.</div>
            <button id="btnInstructor" class="mt-2 w-full btn rounded-2xl px-3 py-2 text-sm font-semibold">
              ‚öôÔ∏è Configurar OVA
            </button>
          </div>
        </div>
      </aside>

      <!-- Content -->
      <main class="lg:col-span-8">
        <div id="content" class="glass rounded-3xl p-4 md:p-6 shadow-glow"></div>
      </main>
    </div>

    <!-- Footer -->
    <div class="mt-5 text-center text-xs text-slate-500">
      Hecho para entrenamiento interno. Version: <span id="ver"></span>
    </div>
  </div>

  <!-- Printable Certificate -->
  <div id="printArea" class="hidden">
    <div class="max-w-3xl mx-auto p-10">
      <div class="border border-slate-300 rounded-2xl p-8">
        <div class="text-xs uppercase tracking-widest text-slate-600">Constancia de repaso</div>
        <div class="text-3xl font-extrabold mt-2 text-slate-900">OVA Decimetrix</div>
        <div class="text-slate-700 mt-2">Normativa UAS y Seguridad Operacional</div>
        <hr class="my-6" />
        <div class="text-slate-800">
          <div><b>Participante:</b> <span id="certName">‚Äî</span></div>
          <div><b>Cargo:</b> <span id="certRole">‚Äî</span></div>
          <div class="mt-3"><b>Puntaje:</b> <span id="certScore">0</span></div>
          <div><b>Progreso:</b> <span id="certProg">0%</span></div>
          <div><b>Resultado:</b> <span id="certResult">‚Äî</span></div>
          <div><b>Fecha:</b> <span id="certDate">‚Äî</span></div>
        </div>
<div class="mt-6 pt-4 border-t border-slate-300">
  <div class="text-slate-800">
    <div class="text-sm"><b>Certifica:</b> OSCAR EDUARDO CRUZ</div>
    <div class="text-sm">Jefe de Pilotos UAS | Decimetrix</div>
  </div>

  <div class="mt-6">
    <div class="w-72 border-b border-slate-400"></div>
    <div class="text-xs text-slate-600 mt-1">Firma y sello</div>
  </div>
</div>
        <div class="mt-8 text-xs text-slate-600">
         Nota: Este documento certifica un repaso formativo, no reemplaza certificaciones aeron√°uticas ni autorizaciones operacionales.
        </div>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div id="modal" class="fixed inset-0 hidden items-center justify-center p-4 no-print">
    <div class="absolute inset-0 bg-black/70"></div>
    <div class="relative glass rounded-3xl p-5 md:p-6 w-full max-w-2xl shadow-glow">
      <div class="flex items-start justify-between gap-3">
        <div>
          <div id="modalTitle" class="text-lg font-extrabold">Modal</div>
          <div id="modalSub" class="text-sm text-slate-300 mt-1">‚Äî</div>
        </div>
        <button id="modalClose" class="chip rounded-2xl px-3 py-2 hover:brightness-110">‚úï</button>
      </div>
      <div id="modalBody" class="mt-4"></div>
    </div>
  </div>

<script>
(() => {
  const APP_VERSION = "1.0.0";
  const LS = {
    profile: "dmx_ova_profile",
    progress: "dmx_ova_progress",
    score: "dmx_ova_score",
    answers: "dmx_ova_answers",
    config: "dmx_ova_config"
  };

  const defaultConfig = {
    instructorEnabled: false,
    instructorKey: "", // no se guarda visible en UI, solo valida acceso
    companyName: "Decimetrix",
    manualAnswers: {
      // Puedes ajustar en Modo Instructor: respuestas correctas del Manual Decimetrix
      canalReporteEvento: "",
      bateriaRTL: "",
      perdidaC2: "",
      geocercas: ""
    },
    observerSpacingM: "" // separaci√≥n est√°ndar entre observadores seg√∫n Manual Decimetrix
  };

  const state = {
    profile: { name: "", role: "" },
    progress: {}, // {lessonId: true}
    score: 0,
    answers: {},  // respuestas del usuario
    config: { ...defaultConfig },
    currentLesson: "inicio",
  };

  const lessons = [
    { id: "inicio", icon: "üë§", title: "Inicio y perfil" },
    { id: "rac100", icon: "üìò", title: "RAC 100 en modo claro" },
    { id: "zona", icon: "üüß", title: "Zona de seguridad" },
    { id: "dronpuerto", icon: "üõ¨", title: "Dronpuerto operativo" },
    { id: "kp", icon: "üß≤", title: "√çndice Kp (decisi√≥n)" },
    { id: "caso1000", icon: "üõ∞Ô∏è", title: "Caso problema: 1.000 m" },
    { id: "observadores", icon: "üëÄ", title: "Observadores (con dibujos)" },
    { id: "manual", icon: "üßæ", title: "Manual Decimetrix (checkpoints)" },
    { id: "cierre", icon: "‚úÖ", title: "Cierre y certificado" },
  ];

  // ---------- Storage ----------
  function load() {
    try {
      const p = JSON.parse(localStorage.getItem(LS.profile) || "null");
      const pr = JSON.parse(localStorage.getItem(LS.progress) || "null");
      const sc = JSON.parse(localStorage.getItem(LS.score) || "null");
      const an = JSON.parse(localStorage.getItem(LS.answers) || "null");
      const cfg = JSON.parse(localStorage.getItem(LS.config) || "null");
      if (p) state.profile = { ...state.profile, ...p };
      if (pr) state.progress = pr;
      if (typeof sc === "number") state.score = sc;
      if (an) state.answers = an;
      if (cfg) state.config = { ...defaultConfig, ...cfg };
    } catch(e) {}
  }

  function save() {
    localStorage.setItem(LS.profile, JSON.stringify(state.profile));
    localStorage.setItem(LS.progress, JSON.stringify(state.progress));
    localStorage.setItem(LS.score, JSON.stringify(state.score));
    localStorage.setItem(LS.answers, JSON.stringify(state.answers));
    localStorage.setItem(LS.config, JSON.stringify(state.config));
    updateChips();
    renderNav();
  }

  function resetAll() {
    Object.values(LS).forEach(k => localStorage.removeItem(k));
    state.profile = { name: "", role: "" };
    state.progress = {};
    state.score = 0;
    state.answers = {};
    state.config = { ...defaultConfig };
    state.currentLesson = "inicio";
    updateChips();
    renderNav();
    renderLesson("inicio");
  }

  // ---------- UI ----------
  const $ = (q) => document.querySelector(q);
  const navEl = $("#nav");
  const contentEl = $("#content");

  function greet() {
    const n = state.profile.name?.trim();
    const r = state.profile.role?.trim();
    if (!n && !r) return "Hola. Arranquemos con calma üôÇ";
    if (n && r) return `Hola, <b>${escapeHtml(n)}</b> (<b>${escapeHtml(r)}</b>).`;
    if (n) return `Hola, <b>${escapeHtml(n)}</b>.`;
    return "Hola.";
  }
function updateChips() {
  const n = (state.profile?.name || "").trim();
  const r = (state.profile?.role || "").trim();

  // Calcular progreso SIN romperse si "lessons" a√∫n no est√° listo
  let total = 1;
  try {
    total = (Array.isArray(lessons) && lessons.length) ? lessons.length : 1;
  } catch (e) {
    total = 1;
  }

  const done = Object.keys(state.progress || {}).filter(k => state.progress[k]).length;
  const pct = Math.round((done / total) * 100);

  // Chips (arriba)
  const chipUser = document.getElementById("chipUser");
  if (chipUser) {
    chipUser.innerHTML = (n || r)
      ? `üë§ ${escapeHtml(n || "Usuario")} | ${escapeHtml(r || "Cargo")}`
      : "üë§ Invitado(a) | Sin perfil";
  }

  const chipScore = document.getElementById("chipScore");
  if (chipScore) chipScore.textContent = `üß† Puntaje: ${state.score || 0}`;

  const chipProgress = document.getElementById("chipProgress");
  if (chipProgress) chipProgress.textContent = `‚úÖ Progreso: ${pct}%`;

  // Certificado
  const certName = document.getElementById("certName");
  if (certName) certName.textContent = n || "‚Äî";

  const certRole = document.getElementById("certRole");
  if (certRole) certRole.textContent = r || "‚Äî";

  const certScore = document.getElementById("certScore");
  if (certScore) certScore.textContent = String(state.score || 0);

  const certProg = document.getElementById("certProg");
  if (certProg) certProg.textContent = `${pct}%`;

  // ‚úÖ APROBADO si logra M√ÅS de 60%
  const passed = pct > 60;
  const certResult = document.getElementById("certResult");
  if (certResult) certResult.textContent = passed ? "APROBADO ‚úÖ" : "REPROBADO ‚ùå";

  const certDate = document.getElementById("certDate");
  if (certDate) certDate.textContent = new Date().toLocaleString("es-CO");
}


    // cert
    $("#certName").textContent = n || "‚Äî";
    $("#certRole").textContent = r || "‚Äî";
    $("#certScore").textContent = String(state.score);
    $("#certProg").textContent = `${pct}%`;
    $("#certDate").textContent = new Date().toLocaleString("es-CO");
  }

  function renderNav() {
    const total = lessons.length;
    const done = Object.keys(state.progress).filter(k => state.progress[k]).length;
    const pct = Math.round((done / total) * 100);

    navEl.innerHTML = `
      <div class="p-3 rounded-2xl chip">
        <div class="flex items-center justify-between">
          <div class="text-sm font-semibold text-slate-200">Tu avance</div>
          <div class="text-xs text-slate-300">${pct}%</div>
        </div>
        <div class="mt-2 h-2 rounded-full bg-slate-800 overflow-hidden">
          <div class="h-2 rounded-full"
               style="width:${pct}%; background: linear-gradient(90deg, rgba(34,211,238,.95), rgba(59,130,246,.9));"></div>
        </div>
      </div>
      <div class="mt-3 space-y-2">
        ${lessons.map(ls => {
          const isDone = !!state.progress[ls.id];
          const isActive = state.currentLesson === ls.id;
          return `
            <button
              class="w-full text-left rounded-2xl px-3 py-3 flex items-center justify-between gap-3
                     ${isActive ? 'btn' : 'chip hover:brightness-110'}"
              onclick="window.__DMX_NAV('${ls.id}')"
              title="${escapeHtml(ls.title)}">
              <div class="flex items-center gap-3">
                <div class="w-9 h-9 rounded-xl grid place-items-center"
                     style="border:1px solid rgba(148,163,184,.22); background: rgba(2,6,23,.55);">
                  <span class="text-lg">${ls.icon}</span>
                </div>
                <div>
                  <div class="text-sm font-semibold">${escapeHtml(ls.title)}</div>
                  <div class="text-xs text-slate-300">${isDone ? "Completado ‚úÖ" : "Pendiente ‚è≥"}</div>
                </div>
              </div>
              <div class="text-lg">${isDone ? "‚úî" : "‚Ä∫"}</div>
            </button>
          `;
        }).join("")}
      </div>
    `;
  }

  window.__DMX_NAV = (id) => renderLesson(id);

  function markDone(lessonId) {
    if (!state.progress[lessonId]) {
      state.progress[lessonId] = true;
      // bonus peque√±o por completar
      state.score += 2;
      save();
      toast("‚úÖ Marcado como completado (+2).");
    } else {
      toast("Este m√≥dulo ya estaba completado üôÇ");
    }
  }

  function toast(msg) {
    const el = document.createElement("div");
    el.className = "fixed bottom-4 left-1/2 -translate-x-1/2 z-50 px-4 py-3 rounded-2xl glass shadow-glow text-sm";
    el.innerHTML = msg;
    document.body.appendChild(el);
    setTimeout(() => el.remove(), 2400);
  }

  function escapeHtml(s) {
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  // ---------- Modal ----------
  function openModal(title, sub, bodyHtml) {
    $("#modalTitle").textContent = title;
    $("#modalSub").textContent = sub || "";
    $("#modalBody").innerHTML = bodyHtml;
    $("#modal").classList.remove("hidden");
    $("#modal").classList.add("flex");
  }
  function closeModal() {
    $("#modal").classList.add("hidden");
    $("#modal").classList.remove("flex");
  }

  $("#modalClose").addEventListener("click", closeModal);
  $("#modal").addEventListener("click", (e) => { if (e.target.id === "modal") closeModal(); });

  // ---------- Lesson Renderers ----------
  function renderLesson(id) {
    state.currentLesson = id;
    save();

    const n = state.profile.name?.trim();
    const r = state.profile.role?.trim();
    const who = n ? `${n}${r ? " ("+r+")" : ""}` : "tu perfil";

    if (id === "inicio") return renderInicio();
    if (id === "rac100") return renderRAC();
    if (id === "zona") return renderZona();
    if (id === "dronpuerto") return renderDronpuerto();
    if (id === "kp") return renderKP();
    if (id === "caso1000") return renderCaso1000();
    if (id === "observadores") return renderObservadores();
    if (id === "manual") return renderManual();
    if (id === "cierre") return renderCierre();

    contentEl.innerHTML = `<div class="text-slate-300">M√≥dulo no encontrado.</div>`;
  }

  // ---- Inicio
  function renderInicio() {
    const n = state.profile.name || "";
    const r = state.profile.role || "";
    contentEl.innerHTML = `
      <div class="flex items-start justify-between gap-3">
        <div>
          <div class="text-2xl md:text-3xl font-extrabold">Inicio</div>
          <div class="text-slate-300 mt-2">
            ${greet()} Aqu√≠ vamos a repasar normativa UAS y seguridad operacional con actividades cortas.
          </div>
        </div>
        <div class="hidden md:block chip rounded-2xl px-3 py-2 text-xs text-slate-300">
          Tip: guarda este archivo como <b>.html</b>
        </div>
      </div>

      <div class="mt-5 grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="chip rounded-3xl p-4">
          <div class="font-bold text-slate-100">1) Identif√≠cate</div>
          <div class="text-sm text-slate-300 mt-1">Tu nombre y cargo quedan guardados en este navegador.</div>

          <div class="mt-4 space-y-3">
            <label class="block text-xs text-slate-400">Nombre</label>
            <input id="inpName" value="${escapeHtml(n)}"
              class="w-full rounded-2xl px-4 py-3 bg-slate-900/60 border border-slate-700/60 outline-none focus:ring-2 focus:ring-cyan-400/30"
              placeholder="Ej: Oscar Eduardo" />

            <label class="block text-xs text-slate-400">Cargo en ${escapeHtml(state.config.companyName)}</label>
            <input id="inpRole" value="${escapeHtml(r)}"
              class="w-full rounded-2xl px-4 py-3 bg-slate-900/60 border border-slate-700/60 outline-none focus:ring-2 focus:ring-cyan-400/30"
              placeholder="Ej: Piloto UAS / Jefe de Pilotos / Analista..." />

            <button id="btnSaveProfile" class="w-full btn rounded-2xl px-4 py-3 font-semibold">
              Guardar perfil ‚úÖ
            </button>

            <div class="text-xs text-slate-400">
              Nota: se guarda en <b>localStorage</b> (solo en tu equipo).
            </div>
          </div>
        </div>

        <div class="chip rounded-3xl p-4">
          <div class="font-bold text-slate-100">2) ¬øQu√© vas a practicar hoy?</div>
          <div class="mt-3 grid grid-cols-2 gap-2 text-sm">
            ${pill("üìò","RAC 100: VLOS/EVLOS/BVLOS")}
            ${pill("üüß","Zona de seguridad")}
            ${pill("üõ¨","Dronpuerto (TLOF/FATO/SA)")}
            ${pill("üß≤","√çndice Kp (GNSS)")}
            ${pill("üõ∞Ô∏è","Caso: 1.000 m")}
            ${pill("üëÄ","Observadores (2 dibujos)")}
            ${pill("üßæ","Manual Decimetrix")}
            ${pill("‚úÖ","Certificado")}
          </div>

          <div class="mt-4 p-3 rounded-2xl border border-cyan-400/25 bg-cyan-400/10 text-sm text-slate-200">
            Regla de oro: si algo ‚Äút√©cnicamente se puede‚Äù (por alcance del dron), eso <b>no significa</b> que sea permitido en operaci√≥n.
          </div>

          <button class="mt-4 w-full chip hover:brightness-110 rounded-2xl px-4 py-3 font-semibold"
                  onclick="window.__DMX_NAV('rac100')">
            Empezar por normativa ‚ûú
          </button>
        </div>
      </div>

      <div class="mt-5 flex items-center justify-between">
        <button class="chip hover:brightness-110 rounded-2xl px-4 py-3" onclick="window.__DMX_NAV('rac100')">
          Siguiente: RAC 100 ‚ûú
        </button>
        <button class="btn rounded-2xl px-4 py-3 font-semibold" onclick="window.__DMX_DONE('inicio')">
          Marcar inicio como listo ‚úÖ
        </button>
      </div>
    `;

    $("#btnSaveProfile").addEventListener("click", () => {
      const name = ($("#inpName").value || "").trim();
      const role = ($("#inpRole").value || "").trim();
      state.profile = { name, role };
      save();
      toast(`Listo. Desde ahora te hablo como <b>${escapeHtml(name || "Usuario")}</b>${role ? " ("+escapeHtml(role)+")" : ""}.`);
      renderLesson("inicio");
    });
  }

  function pill(a,b){
    return `<div class="rounded-2xl px-3 py-2 chip"><div class="font-semibold">${a}</div><div class="text-xs text-slate-300">${escapeHtml(b)}</div></div>`;
  }

  // ---- RAC 100
  function renderRAC() {
    contentEl.innerHTML = `
      <div>
        <div class="text-2xl md:text-3xl font-extrabold">RAC 100 en modo claro</div>
        <div class="text-slate-300 mt-2">
          ${greet()} Vamos con lo esencial: tipos de contacto visual y por qu√© importan.
        </div>
      </div>

      <div class="mt-5 grid grid-cols-1 md:grid-cols-3 gap-3">
        ${card("VLOS","üëÅÔ∏è","Operaci√≥n en l√≠nea de vista. Distancia m√°xima operativa (referencia): <b>750 m</b> desde posici√≥n fija del piloto.")}
        ${card("EVLOS","üëÄüëÄ","L√≠nea de vista extendida con <b>observador(es)</b>. Puede extenderse hasta <b>3 km</b> si alg√∫n observador mantiene la UA a <b>&lt; 750 m</b> y hay comunicaci√≥n constante.")}
        ${card("BVLOS","üõ∞Ô∏è","M√°s all√° de la l√≠nea de vista. Requiere gesti√≥n de vuelo UAS, autorizaciones y controles espec√≠ficos (categor√≠a/permiso).")}
      </div>

      <div class="mt-4 p-4 rounded-3xl chip">
        <div class="font-bold">Mini-actividad 1: Empareja el concepto</div>
        <div class="text-sm text-slate-300 mt-1">Selecciona la opci√≥n correcta para cada definici√≥n.</div>

        <div class="mt-3 space-y-3">
          ${quizMC("q_rac1","¬øCu√°l requiere observador(es) para extender el alcance m√°s all√° del piloto?",
            ["VLOS","EVLOS","BVLOS"], 1,
            "Correcto: EVLOS usa observadores para extender la l√≠nea de vista.",
            "Pista: busca la opci√≥n que expl√≠citamente usa observadores."
          )}

          ${quizMC("q_rac2","Si se pierde la l√≠nea de vista del observador durante EVLOS, ¬øqu√© corresponde hacer?",
            ["Seguir, porque el dron tiene alcance","Cancelar la operaci√≥n hasta recuperar l√≠nea de vista","Subir altura y continuar"], 1,
            "Bien: se cancela y no se reanuda hasta recuperar condiciones de l√≠nea de vista.",
            "No es por alcance t√©cnico: es por control de riesgo y cumplimiento."
          )}
        </div>
      </div>

      <div class="mt-5 flex items-center justify-between">
        <button class="chip hover:brightness-110 rounded-2xl px-4 py-3" onclick="window.__DMX_NAV('zona')">
          Siguiente: Zona de seguridad ‚ûú
        </button>
        <button class="btn rounded-2xl px-4 py-3 font-semibold" onclick="window.__DMX_DONE('rac100')">
          Marcar m√≥dulo como listo ‚úÖ
        </button>
      </div>
    `;
    wireQuiz("q_rac1", 1);
    wireQuiz("q_rac2", 1);
  }

  function card(title,icon,html){
    return `
      <div class="rounded-3xl p-4 chip">
        <div class="flex items-center justify-between">
          <div class="font-extrabold text-lg">${escapeHtml(title)}</div>
          <div class="text-xl">${icon}</div>
        </div>
        <div class="text-sm text-slate-300 mt-2">${html}</div>
      </div>`;
  }

  // ---- Zona
  function renderZona() {
    contentEl.innerHTML = `
      <div>
        <div class="text-2xl md:text-3xl font-extrabold">Zona de seguridad</div>
        <div class="text-slate-300 mt-2">
          ${greet()} Aqu√≠ el objetivo es simple: <b>cero gente dentro de la zona cr√≠tica</b> durante despegue/aterrizaje.
        </div>
      </div>

      <div class="mt-5 grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="chip rounded-3xl p-4">
          <div class="font-bold">Idea operativa</div>
          <div class="text-sm text-slate-300 mt-1">
            En operaci√≥n urbana, una referencia frecuente es mantener separaci√≥n: <b>no volar a menos de 30 m</b> de personas ajenas,
            ni a menos de <b>30 m</b> de edificaciones (horizontal o vertical), y mantener VLOS cuando aplique.
          </div>
          <div class="mt-3 p-3 rounded-2xl border border-amber-400/35 bg-amber-400/10 text-sm text-slate-200">
            Tip Decimetrix: si hay duda, <b>reduces riesgo</b> o <b>paras la operaci√≥n</b>. La operaci√≥n ‚Äúvaliente‚Äù no paga cuentas.
          </div>
        </div>

        <div class="chip rounded-3xl p-4">
          <div class="font-bold">Mini-actividad 2: Riesgo r√°pido</div>
          <div class="text-sm text-slate-300 mt-1">Marca lo correcto.</div>

          <div class="mt-3 space-y-3">
            ${quizMC("q_z1","Durante despegue y aterrizaje, el √°rea de seguridad debe estar‚Ä¶",
              ["Llena de personal para grabar mejor","Libre de personas","Con gente solo si tiene chaleco"], 1,
              "Correcto: libre de personas durante operaci√≥n UAS en esa zona.",
              "La se√±alizaci√≥n no elimina el riesgo f√≠sico."
            )}

            ${quizMC("q_z2","Si tienes transe√∫ntes entrando a tu √°rea, lo m√°s s√≥lido es‚Ä¶",
              ["Acelerar el vuelo para acabar r√°pido","Pausar y asegurar per√≠metro","Ignorar si el dron est√° alto"], 1,
              "Bien: pausar y asegurar per√≠metro.",
              "La prisa es un sesgo cl√°sico de incidentes."
            )}
          </div>
        </div>
      </div>

      <div class="mt-4 chip rounded-3xl p-4">
        <div class="font-bold">Visual: ‚Äúzona cr√≠tica‚Äù (concepto)</div>
        <div class="text-sm text-slate-300 mt-1">
          Usa este diagrama como mapa mental para explicar al equipo d√≥nde <b>s√≠</b> y d√≥nde <b>no</b> se ubica gente.
        </div>

        <div class="mt-3 w-full overflow-hidden rounded-3xl border border-slate-700/60 bg-slate-900/40 p-3">
          ${svgZones()}
        </div>
      </div>

      <div class="mt-5 flex items-center justify-between">
        <button class="chip hover:brightness-110 rounded-2xl px-4 py-3" onclick="window.__DMX_NAV('dronpuerto')">
          Siguiente: Dronpuerto ‚ûú
        </button>
        <button class="btn rounded-2xl px-4 py-3 font-semibold" onclick="window.__DMX_DONE('zona')">
          Marcar m√≥dulo como listo ‚úÖ
        </button>
      </div>
    `;
    wireQuiz("q_z1", 1);
    wireQuiz("q_z2", 1);
  }

  function svgZones(){
    return `
    <svg viewBox="0 0 760 260" class="w-full h-auto">
      <defs>
        <linearGradient id="g1" x1="0" x2="1">
          <stop offset="0" stop-color="rgba(34,211,238,.25)"/>
          <stop offset="1" stop-color="rgba(59,130,246,.20)"/>
        </linearGradient>
      </defs>

      <rect x="12" y="12" width="736" height="236" rx="20" fill="rgba(2,6,23,.40)" stroke="rgba(148,163,184,.25)"/>

      <!-- Outer -->
      <rect x="70" y="40" width="620" height="180" rx="18" fill="rgba(59,130,246,.10)" stroke="rgba(59,130,246,.35)" stroke-dasharray="6 6"/>
      <text x="82" y="60" fill="rgba(191,219,254,.9)" font-size="14" font-weight="700">√ÅREA OPERACI√ìN (equipo autorizado)</text>

      <!-- Safety area -->
      <rect x="170" y="70" width="420" height="120" rx="16" fill="rgba(248,113,113,.10)" stroke="rgba(248,113,113,.55)"/>
      <text x="182" y="92" fill="rgba(254,202,202,.95)" font-size="14" font-weight="700">√ÅREA SEGURIDAD (SIN PERSONAS)</text>

      <!-- Pad -->
      <rect x="320" y="105" width="120" height="60" rx="14" fill="url(#g1)" stroke="rgba(34,211,238,.6)"/>
      <text x="335" y="140" fill="rgba(224,242,254,.95)" font-size="14" font-weight="800">DRONPAD</text>

      <!-- pilot -->
      <circle cx="110" cy="200" r="18" fill="rgba(34,211,238,.22)" stroke="rgba(34,211,238,.7)"/>
      <text x="92" y="233" fill="rgba(226,232,240,.9)" font-size="12">Piloto UAS</text>

      <!-- cones -->
      <circle cx="170" cy="70" r="6" fill="rgba(251,146,60,.95)"/>
      <circle cx="590" cy="70" r="6" fill="rgba(251,146,60,.95)"/>
      <circle cx="170" cy="190" r="6" fill="rgba(251,146,60,.95)"/>
      <circle cx="590" cy="190" r="6" fill="rgba(251,146,60,.95)"/>
      <text x="610" y="205" fill="rgba(251,191,36,.95)" font-size="12">Conos / demarcaci√≥n</text>
    </svg>
    `;
  }

  // ---- Dronpuerto
  function renderDronpuerto() {
    const prevDim = state.answers.dimDrone || 1;
    contentEl.innerHTML = `
      <div>
        <div class="text-2xl md:text-3xl font-extrabold">Dronpuerto operativo</div>
        <div class="text-slate-300 mt-2">
          ${greet()} Un ‚Äúdronpuerto‚Äù es tu <b>ecosistema</b> de despegue/aterrizaje: orden, per√≠metro y disciplina.
        </div>
      </div>

      <div class="mt-5 grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="chip rounded-3xl p-4">
          <div class="font-bold">Componentes t√≠picos</div>
          <ul class="mt-2 text-sm text-slate-300 space-y-2 list-disc pl-5">
            <li><b>TLOF</b>: punto de toma y elevaci√≥n (donde ‚Äútoca‚Äù el dron).</li>
            <li><b>FATO</b>: aproximaci√≥n final y despegue (zona despejada, marcada).</li>
            <li><b>SA</b>: √°rea de seguridad (sin personas, demarcada).</li>
            <li><b>√Årea de operaci√≥n</b>: puesto del piloto y equipo (por fuera de SA).</li>
          </ul>

          <div class="mt-3 p-3 rounded-2xl border border-cyan-400/25 bg-cyan-400/10 text-sm text-slate-200">
            En manuales operacionales colombianos se usa como regla: <b>SA m√≠nimo 3 veces</b> la dimensi√≥n de la aeronave a cada lado (desde FATO).
          </div>
        </div>

        <div class="chip rounded-3xl p-4">
          <div class="font-bold">Mini-actividad 3: Calculadora r√°pida</div>
          <div class="text-sm text-slate-300 mt-1">Escribe la dimensi√≥n aproximada de tu aeronave (metros). La OVA te sugiere SA.</div>

          <div class="mt-3 flex items-center gap-3">
            <input id="inpDim" type="number" min="0.2" step="0.1" value="${escapeHtml(prevDim)}"
              class="w-32 rounded-2xl px-4 py-3 bg-slate-900/60 border border-slate-700/60 outline-none focus:ring-2 focus:ring-cyan-400/30" />
            <button id="btnCalc" class="btn rounded-2xl px-4 py-3 font-semibold">Calcular</button>
          </div>

          <div id="calcOut" class="mt-3 text-sm text-slate-200"></div>

          <div class="mt-3 w-full overflow-hidden rounded-3xl border border-slate-700/60 bg-slate-900/40 p-3">
            <div id="svgPort"></div>
          </div>
        </div>
      </div>

      <div class="mt-5 flex items-center justify-between">
        <button class="chip hover:brightness-110 rounded-2xl px-4 py-3" onclick="window.__DMX_NAV('kp')">
          Siguiente: √çndice Kp ‚ûú
        </button>
        <button class="btn rounded-2xl px-4 py-3 font-semibold" onclick="window.__DMX_DONE('dronpuerto')">
          Marcar m√≥dulo como listo ‚úÖ
        </button>
      </div>
    `;

    const calc = () => {
      const dim = Math.max(0.2, parseFloat($("#inpDim").value || "1"));
      const SA = (dim * 3).toFixed(1);
      state.answers.dimDrone = dim;
      save();
      $("#calcOut").innerHTML = `
        Para una aeronave de <b>${dim.toFixed(1)} m</b>:
        <br>‚Ä¢ Sugerencia SA: <b>${SA} m</b> a cada lado (regla 3x).
        <br><span class="text-slate-400 text-xs">Ajusta seg√∫n tu Manual Decimetrix, terreno, obst√°culos y evaluaci√≥n de riesgos.</span>
      `;
      $("#svgPort").innerHTML = svgDroneport(dim);
      // sumar puntito si interactu√≥
      bumpScoreOnce("calcSA", 3);
    };

    $("#btnCalc").addEventListener("click", calc);
    calc();
  }

  function svgDroneport(dim){
    const SA = Math.max(1, dim * 3);
    const scale = 18; // px per meter (aprox)
    const w = 720, h = 210;
    const saW = Math.min(560, SA * scale * 2);
    const saH = Math.min(140, SA * scale * 1.2);
    const x = (w - saW)/2;
    const y = (h - saH)/2 + 10;
    return `
    <svg viewBox="0 0 ${w} ${h}" class="w-full h-auto">
      <rect x="10" y="10" width="${w-20}" height="${h-20}" rx="18" fill="rgba(2,6,23,.25)" stroke="rgba(148,163,184,.22)"/>
      <rect x="${x}" y="${y}" width="${saW}" height="${saH}" rx="16"
            fill="rgba(248,113,113,.10)" stroke="rgba(248,113,113,.55)"/>
      <text x="${x+14}" y="${y+22}" fill="rgba(254,202,202,.95)" font-size="14" font-weight="800">SA (sin personas)</text>

      <rect x="${w/2 - 90}" y="${h/2 - 24}" width="180" height="48" rx="14"
            fill="rgba(34,211,238,.14)" stroke="rgba(34,211,238,.55)"/>
      <text x="${w/2 - 42}" y="${h/2 + 6}" fill="rgba(224,242,254,.95)" font-size="14" font-weight="900">TLOF / Pad</text>

      <text x="24" y="${h-24}" fill="rgba(148,163,184,.9)" font-size="12">
        Dimensi√≥n dron ‚âà ${dim.toFixed(1)} m | SA sugerida ‚âà ${Math.max(1, dim*3).toFixed(1)} m por lado
      </text>
    </svg>`;
  }

  // ---- KP
  function renderKP() {
    const prev = state.answers.kp ?? "";
    contentEl.innerHTML = `
      <div>
        <div class="text-2xl md:text-3xl font-extrabold">√çndice Kp (decisi√≥n r√°pida)</div>
        <div class="text-slate-300 mt-2">
          ${greet()} Saca el cel y revisa <b>en este momento</b> tu Kp (apps de space weather o el panel que uses). Luego escr√≠belo aqu√≠.
        </div>
      </div>

      <div class="mt-5 grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="chip rounded-3xl p-4">
          <div class="font-bold">¬øPor qu√© importa?</div>
          <div class="text-sm text-slate-300 mt-1">
            Kp describe actividad geomagn√©tica. En actividad alta puede haber degradaci√≥n de navegaci√≥n satelital (GNSS) y problemas intermitentes.
            Esta secci√≥n NO reemplaza tu evaluaci√≥n meteorol√≥gica, NOTAM, permisos, ni checklist.
          </div>

          <div class="mt-3 p-3 rounded-2xl border border-amber-400/35 bg-amber-400/10 text-sm text-slate-200">
            Regla pr√°ctica (entrenamiento): <b>0-4 OK</b> (espacial), <b>5-6 precauci√≥n</b>, <b>7+ no recomendado</b> si tu misi√≥n depende fuerte de GNSS.
          </div>
        </div>

        <div class="chip rounded-3xl p-4">
          <div class="font-bold">Actividad 4: Eval√∫a tu Kp</div>

          <div class="mt-3 flex items-center gap-3">
            <input id="inpKp" type="number" min="0" max="9" step="1" value="${escapeHtml(prev)}"
              class="w-28 rounded-2xl px-4 py-3 bg-slate-900/60 border border-slate-700/60 outline-none focus:ring-2 focus:ring-cyan-400/30"
              placeholder="0-9" />
            <button id="btnKp" class="btn rounded-2xl px-4 py-3 font-semibold">Evaluar</button>
          </div>

          <div id="kpOut" class="mt-3"></div>

          <div class="mt-4 text-xs text-slate-400">
            Consejo: si est√°s en <b>5-6</b>, documenta mitigaciones (RTK si aplica, altitudes seguras, contingencias, RTH verificado, briefing).
          </div>
        </div>
      </div>

      <div class="mt-5 flex items-center justify-between">
        <button class="chip hover:brightness-110 rounded-2xl px-4 py-3" onclick="window.__DMX_NAV('caso1000')">
          Siguiente: Caso 1.000 m ‚ûú
        </button>
        <button class="btn rounded-2xl px-4 py-3 font-semibold" onclick="window.__DMX_DONE('kp')">
          Marcar m√≥dulo como listo ‚úÖ
        </button>
      </div>
    `;

    $("#btnKp").addEventListener("click", () => {
      const kp = parseInt($("#inpKp").value, 10);
      state.answers.kp = isNaN(kp) ? "" : kp;
      save();

      const out = $("#kpOut");
      out.className = "mt-3 p-3 rounded-2xl border text-sm";

      if (isNaN(kp) || kp < 0 || kp > 9) {
        out.classList.add("danger");
        out.innerHTML = `<b>Necesito un n√∫mero entre 0 y 9.</b>`;
        return;
      }

      // Entrenamiento conservador para UAS
      if (kp <= 4) {
        out.classList.add("ok");
        out.innerHTML = `
          <b>KP ${kp}: Condici√≥n espacial favorable ‚úÖ</b>
          <div class="text-slate-300 mt-1">En lo geomagn√©tico, es buen momento. Igual: viento, visibilidad, zona autorizada, checklist.</div>
        `;
        bumpScoreOnce("kp_ok", 5);
      } else if (kp <= 6) {
        out.classList.add("warn");
        out.innerHTML = `
          <b>KP ${kp}: Precauci√≥n ‚ö†Ô∏è</b>
          <div class="text-slate-300 mt-1">Revisa dependencias GNSS, mitiga riesgos (briefing, contingencias, monitoreo) y consulta SOP si la misi√≥n es cr√≠tica.</div>
        `;
        bumpScoreOnce("kp_warn", 4);
      } else {
        out.classList.add("danger");
        out.innerHTML = `
          <b>KP ${kp}: No recomendado para misiones sensibles a GNSS ‚õî</b>
          <div class="text-slate-300 mt-1">Alta actividad geomagn√©tica. Si tu operaci√≥n depende fuerte de GNSS/estabilidad, posponer o redise√±ar con mitigaciones y autorizaci√≥n.</div>
        `;
        bumpScoreOnce("kp_bad", 4);
      }
    });
  }

  // ---- Caso 1000m
  function renderCaso1000() {
    contentEl.innerHTML = `
      <div>
        <div class="text-2xl md:text-3xl font-extrabold">Caso problema: operaci√≥n a 1.000 metros</div>
        <div class="text-slate-300 mt-2">
          ${greet()} Escenario: te piden llevar el dron a <b>1.000 m</b> de distancia horizontal desde tu posici√≥n fija.
        </div>
      </div>

      <div class="mt-5 chip rounded-3xl p-4">
        <div class="font-bold">Pregunta 5 (selecci√≥n √∫nica)</div>
        <div class="text-sm text-slate-300 mt-1">¬øCu√°l opci√≥n es la m√°s correcta y segura?</div>

        <div class="mt-3 space-y-2" id="q_case"></div>

        <div id="caseFeedback" class="mt-3 hidden p-3 rounded-2xl border text-sm"></div>
      </div>

      <div class="mt-5 chip rounded-3xl p-4">
        <div class="font-bold">Dato clave</div>
        <div class="text-sm text-slate-300 mt-1">
          El l√≠mite VLOS de referencia es <b>750 m</b>. Para excederlo, se entra en l√≥gica EVLOS con observadores,
          hasta <b>3 km</b>, con la condici√≥n de que un observador mantenga la UA a <b>&lt; 750 m</b> y con comunicaci√≥n constante.
          Si se pierde esa l√≠nea de vista, se cancela la operaci√≥n.
        </div>
      </div>

      <div class="mt-5 flex items-center justify-between">
        <button class="chip hover:brightness-110 rounded-2xl px-4 py-3" onclick="window.__DMX_NAV('observadores')">
          Siguiente: Observadores (dibujos) ‚ûú
        </button>
        <button class="btn rounded-2xl px-4 py-3 font-semibold" onclick="window.__DMX_DONE('caso1000')">
          Marcar m√≥dulo como listo ‚úÖ
        </button>
      </div>
    `;

    const options = [
      { t: "Claro que s√≠: la norma permite hasta 20 km sin problema.", ok: false,
        why: "El alcance t√©cnico (km del dron) NO equivale a lo permitido por tipo de contacto visual. Para 1.000 m ya superas VLOS de referencia." },
      { t: "Simplemente no se puede, en ning√∫n caso.", ok: false,
        why: "Podr√≠a ser posible bajo EVLOS si cumples requisitos (observador(es), l√≠nea de vista, comunicaci√≥n constante) y procedimientos/autorizaciones." },
      { t: "Se puede SOLO si se planifica como EVLOS con observador(es), y adem√°s se consulta con el Jefe de Pilotos y el Manual Decimetrix.", ok: true,
        why: "Correcto: 1.000 m excede VLOS (750 m). Se requiere estructura EVLOS con observadores, comunicaci√≥n, procedimientos y aprobaci√≥n interna." },
      { t: "Se puede si subes altura y el dron se ve m√°s lejos.", ok: false,
        why: "La altura no ‚Äúlegaliza‚Äù exceder VLOS, y adem√°s suma otros riesgos (espacio a√©reo, obst√°culos, permisos)." },
    ];

    const q = $("#q_case");
    q.innerHTML = options.map((o, i) => `
      <label class="flex items-start gap-3 p-3 rounded-2xl border border-slate-700/60 bg-slate-900/35 hover:brightness-110 cursor-pointer">
        <input type="radio" name="case" value="${i}" class="mt-1">
        <div>
          <div class="font-semibold">${escapeHtml(o.t)}</div>
        </div>
      </label>
    `).join("");

    q.addEventListener("change", () => {
      const idx = parseInt(document.querySelector("input[name='case']:checked").value, 10);
      const o = options[idx];
      const fb = $("#caseFeedback");
      fb.classList.remove("hidden");
      fb.className = "mt-3 p-3 rounded-2xl border text-sm " + (o.ok ? "ok" : "danger");

      fb.innerHTML = `
        <b>${o.ok ? "‚úÖ Bien" : "‚ùå Ojo"}</b>
        <div class="text-slate-300 mt-1">${escapeHtml(o.why)}</div>
        <div class="text-xs text-slate-400 mt-2">
          Tip: ‚ÄúConsulto con Jefe de Pilotos + Manual Decimetrix‚Äù casi siempre es la respuesta que evita errores caros.
        </div>
      `;
      if (o.ok) bumpScoreOnce("case1000_ok", 8);
      else bumpScoreOnce("case1000_try", 2);
    });
  }

  // ---- Observadores con dibujos
  function renderObservadores() {
    const prevStd = state.config.observerSpacingM || state.answers.observerSpacingM || "";
    contentEl.innerHTML = `
      <div>
        <div class="text-2xl md:text-3xl font-extrabold">Observadores UAS (con dibujos)</div>
        <div class="text-slate-300 mt-2">
          ${greet()} Actividad: vas a decidir <b>cada cu√°ntos metros</b> ubicar observadores para sostener la l√≠nea de vista.
        </div>
      </div>

      <div class="mt-5 grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="chip rounded-3xl p-4">
          <div class="font-bold">Paso 1: confirma tu est√°ndar</div>
          <div class="text-sm text-slate-300 mt-1">
            Abre el <b>Manual de Operaciones Decimetrix</b> y busca el est√°ndar de separaci√≥n/relevo de observadores (si existe como n√∫mero).
            Escr√≠belo aqu√≠ (metros). Si tu manual no da un n√∫mero fijo, escribe ‚ÄúDEPENDE‚Äù.
          </div>

          <div class="mt-3 flex items-center gap-3">
            <input id="inpObsStd" value="${escapeHtml(prevStd)}"
              class="w-40 rounded-2xl px-4 py-3 bg-slate-900/60 border border-slate-700/60 outline-none focus:ring-2 focus:ring-cyan-400/30"
              placeholder="Ej: 200 / DEPENDE" />
            <button id="btnSaveObsStd" class="btn rounded-2xl px-4 py-3 font-semibold">Guardar</button>
          </div>

          <div id="obsStdOut" class="mt-3 text-sm text-slate-200"></div>
        </div>

        <div class="chip rounded-3xl p-4">
          <div class="font-bold">Paso 2: mini-c√°lculo</div>
          <div class="text-sm text-slate-300 mt-1">
            Misi√≥n lineal de <b>1.200 m</b>. Con tu est√°ndar, ¬øcu√°ntos observadores (adem√°s del piloto) necesitar√≠as?
          </div>

          <div class="mt-3 flex items-center gap-3">
            <input id="inpGuess" type="number" min="0" step="1"
              class="w-28 rounded-2xl px-4 py-3 bg-slate-900/60 border border-slate-700/60 outline-none focus:ring-2 focus:ring-cyan-400/30"
              placeholder="N" />
            <button id="btnCheckGuess" class="btn rounded-2xl px-4 py-3 font-semibold">Verificar</button>
          </div>
          <div id="guessOut" class="mt-3"></div>
        </div>
      </div>

      <div class="mt-4 chip rounded-3xl p-4">
        <div class="font-bold">Pregunta 6: Elige la mejor l√≥gica (si tu manual dice ‚ÄúDEPENDE‚Äù)</div>
        <div class="mt-3">
          ${quizMC("q_obs_logic",
            "Si el terreno tiene obst√°culos (√°rboles/edificios) y la visibilidad cambia, la separaci√≥n entre observadores deber√≠a‚Ä¶",
            ["Mantenerse fija sin importar nada","Ajustarse para garantizar l√≠nea de vista continua","Aumentar siempre al m√°ximo para ahorrar personal"],
            1,
            "Correcto: se ajusta para sostener l√≠nea de vista continua.",
            "Piensa como SMS: cambias controles seg√∫n peligros."
          )}
        </div>
      </div>

      <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="chip rounded-3xl p-4">
          <div class="font-bold">Dibujo 1: Corredor lineal</div>
          <div class="text-sm text-slate-300 mt-1">El dron avanza en l√≠nea recta. T√∫ decides cada cu√°ntos metros ubicar observadores.</div>
          <div class="mt-3 rounded-3xl border border-slate-700/60 bg-slate-900/40 p-3" id="draw1"></div>
        </div>

        <div class="chip rounded-3xl p-4">
          <div class="font-bold">Dibujo 2: Zona urbana con ‚Äúsombra‚Äù</div>
          <div class="text-sm text-slate-300 mt-1">Hay obst√°culos. Debes garantizar l√≠nea de vista por relevos.</div>
          <div class="mt-3 rounded-3xl border border-slate-700/60 bg-slate-900/40 p-3" id="draw2"></div>
        </div>
      </div>

      <div class="mt-5 flex items-center justify-between">
        <button class="chip hover:brightness-110 rounded-2xl px-4 py-3" onclick="window.__DMX_NAV('manual')">
          Siguiente: Manual Decimetrix ‚ûú
        </button>
        <button class="btn rounded-2xl px-4 py-3 font-semibold" onclick="window.__DMX_DONE('observadores')">
          Marcar m√≥dulo como listo ‚úÖ
        </button>
      </div>
    `;

    // Save observer spacing standard
    const updateStd = () => {
      const v = ($("#inpObsStd").value || "").trim().toUpperCase();
      state.answers.observerSpacingM = v;
      // si instructor configur√≥ un n√∫mero, preferimos ese para evaluaci√≥n
      if (!state.config.observerSpacingM) state.config.observerSpacingM = v;
      save();

      const out = $("#obsStdOut");
      if (!v) {
        out.innerHTML = `<span class="text-slate-400">A√∫n no has escrito tu est√°ndar.</span>`;
        return;
      }
      if (v === "DEPENDE") {
        out.innerHTML = `<b>Guardado:</b> DEPENDE ‚úÖ <div class="text-slate-400 text-xs mt-1">Entonces tu decisi√≥n se basa en mantener l√≠nea de vista continua y comunicaci√≥n.</div>`;
        bumpScoreOnce("obs_depende", 4);
      } else {
        const num = parseFloat(v);
        if (isNaN(num) || num <= 0) {
          out.innerHTML = `<span class="text-red-200">Escribe un n√∫mero v√°lido (ej: 200) o ‚ÄúDEPENDE‚Äù.</span>`;
        } else {
          out.innerHTML = `<b>Guardado:</b> ${num} m ‚úÖ`;
          bumpScoreOnce("obs_num", 4);
        }
      }
      renderDraws();
    };

    $("#btnSaveObsStd").addEventListener("click", updateStd);

    const renderDraws = () => {
      const v = (state.answers.observerSpacingM || "").trim().toUpperCase();
      const spacing = (v && v !== "DEPENDE") ? Math.max(50, Math.min(500, parseFloat(v))) : 200;

      $("#draw1").innerHTML = svgObserversLine(spacing);
      $("#draw2").innerHTML = svgObserversUrban(spacing);
    };

    $("#btnCheckGuess").addEventListener("click", () => {
      const v = (state.answers.observerSpacingM || "").trim().toUpperCase();
      const g = parseInt($("#inpGuess").value, 10);
      const out = $("#guessOut");
      out.className = "mt-3 p-3 rounded-2xl border text-sm";

      if (!v) {
        out.classList.add("warn");
        out.innerHTML = `<b>Primero guarda tu est√°ndar</b> (o escribe DEPENDE).`;
        return;
      }
      if (v === "DEPENDE") {
        out.classList.add("ok");
        out.innerHTML = `
          <b>Si es ‚ÄúDEPENDE‚Äù, tu respuesta debe justificarse.</b>
          <div class="text-slate-300 mt-1">Ej: ‚Äúubico observadores donde el dron pueda perder l√≠nea de vista por obst√°culos; mantengo comunicaci√≥n constante; si se pierde LOS, cancelo‚Äù.</div>
        `;
        bumpScoreOnce("guess_depende", 5);
        return;
      }

      const spacing = parseFloat(v);
      if (isNaN(spacing) || spacing <= 0) {
        out.classList.add("danger");
        out.innerHTML = `<b>El est√°ndar no es num√©rico.</b>`;
        return;
      }

      // Para cubrir 1200 m: observadores en cadena, cada "spacing".
      // Observadores adicionales ‚âà ceil(1200 / spacing) - 1 (porque el piloto ya es un punto)
      const needed = Math.max(0, Math.ceil(1200 / spacing) - 1);

      if (isNaN(g) || g < 0) {
        out.classList.add("warn");
        out.innerHTML = `<b>Escribe un n√∫mero v√°lido.</b>`;
        return;
      }

      if (g === needed) {
        out.classList.add("ok");
        out.innerHTML = `<b>‚úÖ Bien.</b> Con ${spacing} m, estimas ${needed} observador(es) adicional(es).`;
        bumpScoreOnce("guess_ok", 7);
      } else {
        out.classList.add("warn");
        out.innerHTML = `
          <b>Te qued√≥ diferente.</b>
          <div class="text-slate-300 mt-1">Con ${spacing} m, una estimaci√≥n simple da <b>${needed}</b> observador(es) adicional(es).</div>
          <div class="text-slate-400 text-xs mt-2">Ojo: en urbano/obst√°culos suele subir el n√∫mero por ‚Äúsombras‚Äù y puntos ciegos.</div>
        `;
        bumpScoreOnce("guess_try", 2);
      }
    });

    wireQuiz("q_obs_logic", 1);
    updateStd();
    renderDraws();
  }

  function svgObserversLine(spacing){
    // Draw 0..1200 m with markers each spacing
    const dist = 1200;
    const w = 720, h = 220;
    const x0 = 40, x1 = w - 40;
    const y = 120;
    const toX = (m) => x0 + (m/dist) * (x1-x0);

    const marks = [];
    for (let m = 0; m <= dist; m += spacing) marks.push(m);
    // ensure end
    if (marks[marks.length-1] !== dist) marks.push(dist);

    const obs = marks.slice(1, -1); // exclude pilot at 0 and end point

    return `
    <svg viewBox="0 0 ${w} ${h}" class="w-full h-auto">
      <rect x="10" y="10" width="${w-20}" height="${h-20}" rx="18" fill="rgba(2,6,23,.25)" stroke="rgba(148,163,184,.22)"/>
      <text x="24" y="40" fill="rgba(226,232,240,.9)" font-weight="800">Ruta lineal (0 - 1.200 m)</text>
      <text x="24" y="58" fill="rgba(148,163,184,.9)" font-size="12">Espaciado visual: ${Math.round(spacing)} m (aj√∫stalo seg√∫n Manual Decimetrix)</text>

      <line x1="${x0}" y1="${y}" x2="${x1}" y2="${y}" stroke="rgba(34,211,238,.55)" stroke-width="3" stroke-linecap="round" />
      <circle cx="${toX(0)}" cy="${y}" r="9" fill="rgba(34,211,238,.22)" stroke="rgba(34,211,238,.85)"/>
      <text x="${toX(0)-16}" y="${y+28}" fill="rgba(226,232,240,.9)" font-size="12">Piloto</text>

      <circle cx="${toX(dist)}" cy="${y}" r="9" fill="rgba(59,130,246,.18)" stroke="rgba(59,130,246,.85)"/>
      <text x="${toX(dist)-18}" y="${y+28}" fill="rgba(226,232,240,.9)" font-size="12">Objetivo</text>

      ${obs.map(m => `
        <circle cx="${toX(m)}" cy="${y}" r="7" fill="rgba(251,191,36,.18)" stroke="rgba(251,191,36,.9)"/>
        <path d="M ${toX(m)} ${y-22} v 10" stroke="rgba(251,191,36,.6)" stroke-width="2" />
        <text x="${toX(m)-12}" y="${y-28}" fill="rgba(251,191,36,.95)" font-size="11">Obs</text>
      `).join("")}

      ${marks.map(m => `
        <line x1="${toX(m)}" y1="${y-10}" x2="${toX(m)}" y2="${y+10}" stroke="rgba(148,163,184,.25)" />
      `).join("")}
    </svg>`;
  }

  function svgObserversUrban(spacing){
    const w = 720, h = 220;
    // We simulate obstacles and suggest extra observers near shadows
    const pts = [0, spacing, spacing*2, spacing*3, spacing*4, spacing*5].filter(x => x <= 1200);
    return `
    <svg viewBox="0 0 ${w} ${h}" class="w-full h-auto">
      <rect x="10" y="10" width="${w-20}" height="${h-20}" rx="18" fill="rgba(2,6,23,.25)" stroke="rgba(148,163,184,.22)"/>
      <text x="24" y="40" fill="rgba(226,232,240,.9)" font-weight="800">Urbano (obst√°culos y sombra)</text>
      <text x="24" y="58" fill="rgba(148,163,184,.9)" font-size="12">Si hay sombra visual, reduces distancia real o sumas observadores.</text>

      <!-- buildings -->
      <rect x="250" y="92" width="80" height="70" rx="10" fill="rgba(148,163,184,.14)" stroke="rgba(148,163,184,.25)"/>
      <rect x="340" y="78" width="90" height="84" rx="10" fill="rgba(148,163,184,.10)" stroke="rgba(148,163,184,.25)"/>
      <rect x="460" y="102" width="70" height="60" rx="10" fill="rgba(148,163,184,.12)" stroke="rgba(148,163,184,.25)"/>

      <!-- shadow cone -->
      <path d="M 330 85 L 620 40 L 620 185 Z" fill="rgba(248,113,113,.12)" />
      <text x="530" y="60" fill="rgba(254,202,202,.95)" font-size="12" font-weight="800">Zona sombra</text>

      <!-- route -->
      <path d="M 70 160 C 160 120, 260 190, 360 145 S 560 110, 650 150"
            fill="none" stroke="rgba(34,211,238,.6)" stroke-width="3" stroke-linecap="round"/>
      <circle cx="70" cy="160" r="9" fill="rgba(34,211,238,.22)" stroke="rgba(34,211,238,.85)"/>
      <text x="50" y="190" fill="rgba(226,232,240,.9)" font-size="12">Piloto</text>

      <!-- observers suggested -->
      <circle cx="180" cy="135" r="7" fill="rgba(251,191,36,.18)" stroke="rgba(251,191,36,.9)"/>
      <text x="166" y="118" fill="rgba(251,191,36,.95)" font-size="11">Obs</text>

      <circle cx="300" cy="170" r="7" fill="rgba(251,191,36,.18)" stroke="rgba(251,191,36,.9)"/>
      <text x="286" y="153" fill="rgba(251,191,36,.95)" font-size="11">Obs</text>

      <circle cx="470" cy="120" r="7" fill="rgba(251,191,36,.18)" stroke="rgba(251,191,36,.9)"/>
      <text x="456" y="103" fill="rgba(251,191,36,.95)" font-size="11">Obs</text>

      <circle cx="590" cy="150" r="7" fill="rgba(251,191,36,.18)" stroke="rgba(251,191,36,.9)"/>
      <text x="576" y="133" fill="rgba(251,191,36,.95)" font-size="11">Obs</text>

      <rect x="24" y="72" width="210" height="78" rx="14" fill="rgba(15,23,42,.55)" stroke="rgba(148,163,184,.22)"/>
      <text x="38" y="96" fill="rgba(226,232,240,.92)" font-size="12" font-weight="800">Tu est√°ndar guardado:</text>
      <text x="38" y="118" fill="rgba(148,163,184,.95)" font-size="12">Separaci√≥n base ‚âà ${Math.round(spacing)} m</text>
      <text x="38" y="138" fill="rgba(148,163,184,.95)" font-size="12">En sombra: probablemente menos.</text>
    </svg>`;
  }

  // ---- Manual Decimetrix (checkpoints)
  function renderManual() {
    contentEl.innerHTML = `
      <div>
        <div class="text-2xl md:text-3xl font-extrabold">Manual de Operaciones Decimetrix</div>
        <div class="text-slate-300 mt-2">
          ${greet()} Aqu√≠ no voy a inventar tu manual. Esta secci√≥n es una <b>b√∫squeda guiada</b>: t√∫ confirmas en el documento y registras.
        </div>
      </div>

      <div class="mt-5 chip rounded-3xl p-4">
        <div class="font-bold">Checkpoints del Manual (actividad 7)</div>
        <div class="text-sm text-slate-300 mt-1">
          Abre el Manual Decimetrix y responde. Si est√°s en modo Instructor, se puede calificar autom√°ticamente.
        </div>

        <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
          ${manualField("canalReporteEvento","¬øCu√°l es el canal/protocolo para reportar un evento de seguridad operacional?","Ej: grupo interno, correo, formato, responsable")}
          ${manualField("bateriaRTL","¬øCon qu√© % de bater√≠a tu manual recomienda disparar RTL o abortar misi√≥n?","Ej: 30%, 25%, o criterio")}
          ${manualField("perdidaC2","¬øQu√© dice el manual ante p√©rdida/degradaci√≥n del enlace C2?","Ej: activar RTH, abortar, protocolo")}
          ${manualField("geocercas","¬øC√≥mo se gestionan geocercas/√°rea aprobada antes del vuelo?","Ej: app, l√≠mites, validaci√≥n")}
        </div>

        <div class="mt-4 flex flex-col md:flex-row gap-3">
          <button id="btnSaveManual" class="btn rounded-2xl px-4 py-3 font-semibold">Guardar respuestas</button>
          <button id="btnGradeManual" class="chip hover:brightness-110 rounded-2xl px-4 py-3 font-semibold">Calificar (si hay clave)</button>
        </div>

        <div id="manualOut" class="mt-3"></div>
      </div>

      <div class="mt-5 flex items-center justify-between">
        <button class="chip hover:brightness-110 rounded-2xl px-4 py-3" onclick="window.__DMX_NAV('cierre')">
          Siguiente: Cierre ‚ûú
        </button>
        <button class="btn rounded-2xl px-4 py-3 font-semibold" onclick="window.__DMX_DONE('manual')">
          Marcar m√≥dulo como listo ‚úÖ
        </button>
      </div>
    `;

    $("#btnSaveManual").addEventListener("click", () => {
      const keys = Object.keys(state.config.manualAnswers);
      keys.forEach(k => {
        const v = ($("#mf_"+k).value || "").trim();
        state.answers["manual_"+k] = v;
      });
      save();
      $("#manualOut").className = "mt-3 p-3 rounded-2xl border ok text-sm";
      $("#manualOut").innerHTML = `<b>‚úÖ Guardado.</b> Queda registrado para tu repaso y auditor√≠a interna.`;
      bumpScoreOnce("manual_saved", 6);
    });

    $("#btnGradeManual").addEventListener("click", () => {
      const cfg = state.config.manualAnswers || {};
      const keys = Object.keys(cfg);

      // Solo califica si instructor carg√≥ respuestas correctas
      const hasKey = keys.some(k => (cfg[k] || "").trim().length > 0);
      const out = $("#manualOut");
      out.className = "mt-3 p-3 rounded-2xl border text-sm";

      if (!hasKey) {
        out.classList.add("warn");
        out.innerHTML = `<b>Modo instructor no configurado.</b> Puedes usar ‚öôÔ∏è Configurar OVA para cargar respuestas del Manual Decimetrix.`;
        return;
      }

      let ok = 0, total = keys.length;
      const diffs = [];
      keys.forEach(k => {
        const expected = (cfg[k] || "").trim().toLowerCase();
        const got = ((state.answers["manual_"+k] || "")).trim().toLowerCase();
        if (expected && got && (got.includes(expected) || expected.includes(got))) ok++;
        else diffs.push(k);
      });

      const pts = ok * 4;
      state.score += pts;
      save();

      out.classList.add(ok === total ? "ok" : "warn");
      out.innerHTML = `
        <b>Resultado:</b> ${ok}/${total}
        <div class="text-slate-300 mt-1">Sumaste <b>+${pts}</b> puntos.</div>
        ${diffs.length ? `<div class="text-slate-400 text-xs mt-2">Revisa estos √≠tems: ${diffs.map(d => `<b>${escapeHtml(d)}</b>`).join(", ")}</div>` : ""}
      `;
    });

    // prefill fields
    Object.keys(state.config.manualAnswers).forEach(k => {
      const val = state.answers["manual_"+k] || "";
      const el = $("#mf_"+k);
      if (el) el.value = val;
    });
  }

  function manualField(key, label, ph){
    return `
      <div class="rounded-3xl p-4 border border-slate-700/60 bg-slate-900/35">
        <div class="font-semibold">${escapeHtml(label)}</div>
        <textarea id="mf_${escapeHtml(key)}" rows="3"
          class="mt-2 w-full rounded-2xl px-4 py-3 bg-slate-950/40 border border-slate-700/60 outline-none focus:ring-2 focus:ring-cyan-400/30"
          placeholder="${escapeHtml(ph)}"></textarea>
        <div class="text-xs text-slate-400 mt-2">Tip: pega la <b>secci√≥n/p√°gina</b> del manual para trazabilidad.</div>
      </div>`;
  }

  // ---- Cierre
  function renderCierre() {
    const total = lessons.length;
    const done = Object.keys(state.progress).filter(k => state.progress[k]).length;
    const pct = Math.round((done / total) * 100);

    contentEl.innerHTML = `
      <div>
        <div class="text-2xl md:text-3xl font-extrabold">Cierre</div>
        <div class="text-slate-300 mt-2">
          ${greet()} Buen repaso. Ahora deja esto listo para evidencia interna.
        </div>
      </div>

      <div class="mt-5 grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="chip rounded-3xl p-4">
          <div class="font-bold">Resumen</div>
          <div class="text-sm text-slate-300 mt-2">
            ‚Ä¢ Puntaje: <b>${state.score}</b><br>
            ‚Ä¢ Progreso: <b>${pct}%</b><br>
            ‚Ä¢ Perfil: <b>${escapeHtml(state.profile.name || "‚Äî")}</b> (${escapeHtml(state.profile.role || "‚Äî")})
          </div>

          <div class="mt-3 p-3 rounded-2xl border border-cyan-400/25 bg-cyan-400/10 text-sm text-slate-200">
            Cierre operativo: si vas a volar, el orden es: <b>permiso/zona autorizada</b> ‚Üí <b>briefing</b> ‚Üí <b>dronpuerto</b> ‚Üí <b>checklist</b> ‚Üí <b>mitigaciones</b>.
          </div>
        </div>

        <div class="chip rounded-3xl p-4">
          <div class="font-bold">Certificado imprimible</div>
          <div class="text-sm text-slate-300 mt-2">
            Puedes ‚ÄúImprimir‚Äù y elegir <b>Guardar como PDF</b> para dejar evidencia del repaso.
          </div>
          <button id="btnPrint" class="mt-3 w-full btn rounded-2xl px-4 py-3 font-semibold">
            üñ®Ô∏è Imprimir / Guardar PDF
          </button>

          <button id="btnGoStart" class="mt-3 w-full chip hover:brightness-110 rounded-2xl px-4 py-3 font-semibold">
            Volver al inicio ‚Ü©
          </button>
        </div>
      </div>

      <div class="mt-5 flex items-center justify-between">
        <button class="chip hover:brightness-110 rounded-2xl px-4 py-3" onclick="window.__DMX_NAV('inicio')">
          Inicio
        </button>
        <button class="btn rounded-2xl px-4 py-3 font-semibold" onclick="window.__DMX_DONE('cierre')">
          Marcar cierre como listo ‚úÖ
        </button>
      </div>
    `;

    $("#btnPrint").addEventListener("click", () => {
      // Actualiza datos
      updateChips();
      window.print();
    });
    $("#btnGoStart").addEventListener("click", () => renderLesson("inicio"));
  }

  // ---------- Quiz helpers ----------
  function quizMC(id, question, options, correctIdx, okText, badText){
    // id used for wiring
    return `
      <div class="rounded-3xl p-3 border border-slate-700/60 bg-slate-900/35" id="${escapeHtml(id)}">
        <div class="font-semibold">${escapeHtml(question)}</div>
        <div class="mt-2 space-y-2">
          ${options.map((t,i)=>`
            <label class="flex items-start gap-3 p-2 rounded-2xl border border-slate-700/60 bg-slate-950/25 hover:brightness-110 cursor-pointer">
              <input type="radio" name="${escapeHtml(id)}_r" value="${i}" class="mt-1">
              <div class="text-sm text-slate-200">${escapeHtml(t)}</div>
            </label>
          `).join("")}
        </div>
        <div class="mt-2 hidden p-3 rounded-2xl border text-sm" data-fb></div>
        <div class="hidden" data-correct>${correctIdx}</div>
        <div class="hidden" data-ok>${escapeHtml(okText)}</div>
        <div class="hidden" data-bad>${escapeHtml(badText)}</div>
      </div>
    `;
  }

  function wireQuiz(id, correctIdx){
    const root = document.getElementById(id);
    if (!root) return;
    const fb = root.querySelector("[data-fb]");
    const correct = parseInt(root.querySelector("[data-correct]").textContent, 10);
    const okText = root.querySelector("[data-ok]").textContent;
    const badText = root.querySelector("[data-bad]").textContent;

    root.addEventListener("change", () => {
      const sel = root.querySelector(`input[name="${id}_r"]:checked`);
      if (!sel) return;
      const v = parseInt(sel.value, 10);

      fb.classList.remove("hidden");
      fb.className = "mt-2 p-3 rounded-2xl border text-sm " + (v === correct ? "ok" : "warn");
      fb.innerHTML = `<b>${v===correct ? "‚úÖ Correcto" : "‚ö†Ô∏è Revisa"}</b><div class="text-slate-300 mt-1">${v===correct ? okText : badText}</div>`;

      if (v === correct) bumpScoreOnce("quiz_"+id, 6);
      else bumpScoreOnce("quiztry_"+id, 2);
    });
  }

  // ---------- Score helper (avoid farming) ----------
  function bumpScoreOnce(key, points){
    if (state.answers["_sc_"+key]) return;
    state.answers["_sc_"+key] = true;
    state.score += points;
    save();
  }

  // ---------- Instructor config ----------
  function openInstructor() {
    openModal(
      "Configurar OVA (Modo Instructor)",
      "Carga respuestas oficiales del Manual Decimetrix y est√°ndar de observadores para calificar.",
      `
      <div class="space-y-4">
        <div class="p-3 rounded-2xl border border-amber-400/35 bg-amber-400/10 text-sm text-slate-200">
          Esto es opcional. Si no lo configuras, la OVA sigue sirviendo como repaso guiado.
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <div>
            <label class="text-xs text-slate-400">Nombre de la empresa</label>
            <input id="cfgCompany" value="${escapeHtml(state.config.companyName)}"
              class="mt-1 w-full rounded-2xl px-4 py-3 bg-slate-900/60 border border-slate-700/60 outline-none focus:ring-2 focus:ring-cyan-400/30" />
          </div>
          <div>
            <label class="text-xs text-slate-400">Separaci√≥n est√°ndar observadores (m) o DEPENDE</label>
            <input id="cfgObs" value="${escapeHtml(state.config.observerSpacingM)}"
              class="mt-1 w-full rounded-2xl px-4 py-3 bg-slate-900/60 border border-slate-700/60 outline-none focus:ring-2 focus:ring-cyan-400/30"
              placeholder="Ej: 200 / DEPENDE" />
          </div>
        </div>

        <div class="text-sm font-semibold">Respuestas del Manual (para calificar)</div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          ${cfgField("canalReporteEvento","Canal reporte evento", state.config.manualAnswers.canalReporteEvento)}
          ${cfgField("bateriaRTL","Bater√≠a RTL / abortar", state.config.manualAnswers.bateriaRTL)}
          ${cfgField("perdidaC2","P√©rdida enlace C2", state.config.manualAnswers.perdidaC2)}
          ${cfgField("geocercas","Geocercas / √°rea aprobada", state.config.manualAnswers.geocercas)}
        </div>

        <div class="flex flex-col md:flex-row gap-3 pt-2">
          <button id="cfgSave" class="btn rounded-2xl px-4 py-3 font-semibold w-full">Guardar configuraci√≥n</button>
          <button id="cfgClear" class="chip hover:brightness-110 rounded-2xl px-4 py-3 font-semibold w-full">Limpiar respuestas</button>
        </div>

        <div class="text-xs text-slate-400">
          Sugerencia: pega fragmentos cortos o palabras clave, no textos largos, para que el match sea flexible.
        </div>
      </div>
      `
    );

    $("#cfgSave").addEventListener("click", () => {
      state.config.companyName = ($("#cfgCompany").value || "Decimetrix").trim();
      state.config.observerSpacingM = ($("#cfgObs").value || "").trim().toUpperCase();
      Object.keys(state.config.manualAnswers).forEach(k => {
        state.config.manualAnswers[k] = ($("#cfg_"+k).value || "").trim();
      });
      save();
      closeModal();
      toast("‚öôÔ∏è Configuraci√≥n guardada.");
      renderLesson(state.currentLesson);
    });

    $("#cfgClear").addEventListener("click", () => {
      Object.keys(state.config.manualAnswers).forEach(k => state.config.manualAnswers[k] = "");
      state.config.observerSpacingM = "";
      save();
      closeModal();
      toast("Listo: respuestas limpiadas.");
      renderLesson(state.currentLesson);
    });
  }

  function cfgField(key, label, val){
    return `
      <div class="rounded-3xl p-3 border border-slate-700/60 bg-slate-900/35">
        <label class="text-xs text-slate-400">${escapeHtml(label)}</label>
        <input id="cfg_${escapeHtml(key)}" value="${escapeHtml(val || "")}"
          class="mt-1 w-full rounded-2xl px-4 py-3 bg-slate-950/35 border border-slate-700/60 outline-none focus:ring-2 focus:ring-cyan-400/30"
          placeholder="Ej: correo, porcentaje, frase clave..." />
      </div>
    `;
  }

  // expose done function
  window.__DMX_DONE = (lessonId) => markDone(lessonId);

  // ---------- Bindings ----------
  $("#btnReset").addEventListener("click", () => {
    openModal(
      "Reiniciar OVA",
      "Esto borra tu perfil, respuestas, progreso y puntaje en este navegador.",
      `
        <div class="text-slate-300 text-sm">
          ¬øSeguro que quieres reiniciar?
        </div>
        <div class="mt-4 flex gap-3">
          <button class="chip hover:brightness-110 rounded-2xl px-4 py-3 font-semibold w-full" onclick="document.getElementById('modal').classList.add('hidden');document.getElementById('modal').classList.remove('flex');">
            Cancelar
          </button>
          <button class="btn rounded-2xl px-4 py-3 font-semibold w-full" onclick="window.__DMX_RESET_NOW()">
            S√≠, reiniciar
          </button>
        </div>
      `
    );
  });

  window.__DMX_RESET_NOW = () => { closeModal(); resetAll(); };

  $("#btnInstructor").addEventListener("click", openInstructor);

  $("#ver").textContent = APP_VERSION;

  // ---------- Boot ----------
  load();
  updateChips();
  renderNav();
  // Decide default lesson
  if (state.profile.name || state.profile.role) {
    renderLesson(state.currentLesson || "rac100");
  } else {
    renderLesson("inicio");
  }
})();
</script>

</body>

</html>



